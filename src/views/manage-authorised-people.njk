{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tag/macro.njk" import govukTag %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}
{% from "macros/link.njk" import prepareHref %}
{% from "macros/providedTextOrDefault.njk" import providedTextOrDefault %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/error-message/macro.njk" import govukErrorMessage %}

{% extends "layouts/default.njk" %}

{% set message = null %}

{% set errorTitlePrefix = "" %}

{% for key, value in errors %}
    {% if key == "searchEmail" %}
        {% set message = lang[value.text] %}
        {% set errorTitlePrefix = lang.title_error %}
    {% endif %}
{% endfor %}

{% if companyAssociations and companyAssociations.items %}
    {% set company_association = companyAssociations.items | first %}
{% else %}
    {% set company_association = null %}
{% endif %}

{% if pagination and pagination.items | length %}
    {% set title = errorTitlePrefix + lang.title_manage_authorised_people_start + " " + lang.title_page + pageNumber + lang.title_of + numberOfPages + ")" + lang.title_manage_authorised_people_finish %}
{% else %}
    {% set title = errorTitlePrefix + lang.title_manage_authorised_people %}
{% endif %}

{% block back_link %}

    <div role="navigation" aria-label="{{lang.go_back_to_your_companies}}">
        {{ govukBackLink({text: lang.go_back_to_your_companies, href: backLinkHref, attributes: {
                id: "back-link-to-your-companies-page",
                "data-event-id": "back-link-to-previous-page"
            } }) }}
    </div>

{% endblock %}

{% block main_content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-three-quarters">
            <h1 class="govuk-heading-l">
                <span class="govuk-caption-l">{{companyName}} ({{companyNumber}})</span>
                {{lang.people_digitally_authorised_to_file_online}}
            </h1>
            {{ govukInsetText({
                    text: lang.anyone_with_access_to_the_current_authentication
                })
            }}
            {{ govukButton({
            text: lang.add_new_authorised_person, 
            href: buttonHref, 
            attributes: {
                id: "add-new-authorised-person",
                "data-event-id": "add-new-authorised-person"
                } 
            }) }}
        </div>
    </div>

    {% set formClasses = "govuk-form-group govuk-form-group--error" if message else "govuk-form-group" %}
    {% set inputClasses = "govuk-input govuk-input--error govuk-!-margin-right-1 govuk-input--width-20" if message else "govuk-input govuk-input--width-20 govuk-!-margin-right-1" %}

    <form method="post" action="{{manageAuthorisedPeopleUrl}}" novalidate>
        {% include "partials/csrf_token.njk" %}
        <div class="{{formClasses}}">
            <label class="govuk-label govuk-label--m" for="search">
                {{lang.search_authorised_people}}
            </label>
            <div id="event-name-hint" class="govuk-hint">
                {{lang.enter_their_full_email_address}}
            </div>
            {% if message %}
                {{ govukErrorMessage({
                            text: message,
                            visuallyHiddenText: lang.visually_hidden_error
                        })
                    }}
            {% endif %}
            <div id="search-input-group">
                <input class="{{inputClasses}}" id="search" name="searchEmail" type="email" aria-describedby="event-name-hint" value="{{searchEmail}}">
                <button type="submit" name="action" value="trySearch" class="govuk-button govuk-button--secondary" role="button" data-module="govuk-button" aria-label="{{lang.search}}" data-event-id="your-companies-search-for-company-button" id="your-companies-search-for-company-button">{{lang.search}}
                </button>
                <a class="govuk-link govuk-link--no-visited-state govuk-!-font-size-19  govuk-!-margin-left-2" href="{{cancelSearchHref}}" id="manage-users-cancel-search-link" data-event-id="manage-users-cancel-search-link">{{lang.clear_search}}</a>
            </div>
        </div>
    </form>

    {% if validSearch %}
        {% if not resultsFound %}
            <div class = "govuk-grid-row">
                <div class="govuk-grid-column-three-quarters">
                    <h2 class="govuk-heading-s">{{lang.no_results_found}}</h2>
                    <p class="govuk-body">{{lang.no_results_that_match}}</p>
                    <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
                </div>
            </div>
        {% else %}
            <div class = "govuk-grid-row">
                <div class="govuk-grid-column-three-quarters">
                    <h2 class="govuk-heading-s">
                        {{lang.result}}</h2>
                    <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
                </div>
            </div>
        {% endif %}
    {% endif %}

    {% if validSearch == false or resultsFound == true %}

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-three-quarters">

                <h2 class="govuk-heading-m govuk-!-margin-top-4">{{lang.details_of_authorised_people}}</h2>

                {% for association in companyAssociations.items %}
                    {% set userEmail = association.userEmail %}
                    {% set defaultDisplayName = lang.not_provided %}
                    {% set displayNameText =  providedTextOrDefault(association.displayName, defaultDisplayName, notProvided)%}
                    {% set removeHref = prepareHref(removeUrl, {
                        associationId: association.id,
                        companyNumber: association.companyNumber
                    }) | trim %}

                    {% if association.status === confirmed %}
                        {% set tag = govukTag({text: lang.authorised, classes: "govuk-tag--green"}) %}
                        {% set removeLinkVisuallyHiddenText = " " %}

                        {% if userId == association.userId %}
                           {% set dataEventIdForRemoval = "remove-yourself" %}
                        {% else %}
                           {% set dataEventIdForRemoval = "remove-confirmed-person" %}
                        {% endif %}

                        {{ govukSummaryList({
                    card: {
                        title: {
                            text: userEmail
                        },
                        actions: {
                            items: [
                                {
                                    href: removeHref,
                                    text: lang.remove,
                                    visuallyHiddenText: removeLinkVisuallyHiddenText,
                                    attributes:
                                    {
                                        "data-event-id": dataEventIdForRemoval
                                    }
                                }
                            ]
                        }
                    },
                    rows: [
                        {
                        key: {
                            text: lang.name
                        },
                        value: {
                            html: displayNameText
                        }
                        },
                        {
                        key: {
                            text: lang.digital_authorisation
                        },
                        value: {
                            html: tag
                        }
                        }
                    ]
                    }) }}
                    {% endif %}

                    {% if association.status === "awaiting-approval" %}

                        {% set resendEmailLinkVisuallyHiddenText = lang.to + " " %}

                        {% set resendHref = prepareHref(resendEmailUrl, {userEmail: userEmail}) | trim %}

                        {% set awaitingConfirmation %}
                        <div class="govuk-!-padding-bottom-2">
                            <strong class="govuk-tag govuk-tag--yellow">{{lang.awaiting_confirmation }}</strong>
                        </div>
                        {% endset %}

                        {% set cancelLinkVisuallyHiddenText = " " %}

                        {{ govukSummaryList({
                        card: {
                            title: {
                                text: userEmail
                            },
                            actions: {
                                items: [
                                {
                                    href: removeHref,
                                    text: lang.cancel,
                                    visuallyHiddenText: cancelLinkVisuallyHiddenText,
                                    attributes:
                                        {
                                            "data-event-id": "remove-awaiting-approval-person"
                                        }
                                }
                                ]
                            }
                        },
                        rows: [
                            {
                            key: {
                                text: lang.name
                            },
                            value: {
                                html: displayNameText
                            }
                            },
                            {
                            key: {
                                text: lang.digital_authorisation
                            },
                            value: {
                                html: awaitingConfirmation
                            },
                            actions: {
                                items: [
                                {
                                    href: resendHref,
                                    text: lang.resend_email,
                                    visuallyHiddenText: resendEmailLinkVisuallyHiddenText,
                                    attributes:
                                        {
                                            "data-event-id": "resend-invite-email"
                                        }
                                }
                                ]
                            }
                        ]}
                    }) }}

                    {% endif %}

                    {% if (association.status === "migrated" or association.status === "unauthorised") %}

                        {% if association.status === "unauthorised" %}
                            {% set notAuthorisedText %}
                                <div class="govuk-!-padding-bottom-2">
                                    <strong class="govuk-tag govuk-tag--red">{{ lang.not_authorised }}</strong>
                                </div>
                            {% endset %}
                        {% else %}
                            {% set notAuthorisedText %}
                            {% endset %}
                        {% endif %}

                      
                        {% set visuallyHiddenRestoreText = lang.for %}
                        {% set restoreDigitalAuthUrl = restoreDigitalAuthBaseUrl + "/" + association.id %}

                        {% set visuallyHiddenRemoveNotRestoreText = lang.digital_authorisation_for %}

                        {{ govukSummaryList({
                        card: {
                            title: {
                                text: userEmail
                            },
                            actions: {
                                items: [
                                {
                                    href: removeHref,
                                    text: lang.remove,
                                    visuallyHiddenText: visuallyHiddenRemoveNotRestoreText,
                                    attributes:
                                        {
                                            "data-event-id": "remove-migrated-or-unauthorised-person"
                                        }
                                }
                                ]
                            }
                        },
                        rows: [
                            {
                            key: {
                                text: lang.name
                            },
                            value: {
                                html: displayNameText
                            }
                            },
                            {
                            key: {
                                text: lang.digital_authorisation
                            },
                            value: {
                                html: notAuthorisedText
                            },
                            actions: {
                                items: [
                                    {
                                        href: restoreDigitalAuthUrl,
                                        text: lang.restore_authorisation,
                                        visuallyHiddenText: visuallyHiddenRestoreText,
                                        attributes: {
                                            "data-event-id": "restore-migrated-or-unauthorised-person"
                                            }
                                    }
                                    ]
                                }
                            }
                        ]
                            }) }}
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="govuk-grid-row govuk-!-padding-top-2">
            <div class="govuk-grid-column-three-quarters">

                {% if pagination and pagination.items | length %}
                    {{ govukPagination(pagination) }}
                {% endif %}
            </div>
        </div>

    {% endif %}

    {% include "partials/track-goals-manage-auth.njk" %}
{% endblock %}