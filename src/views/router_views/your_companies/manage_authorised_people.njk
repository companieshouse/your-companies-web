{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tag/macro.njk" import govukTag %}
{% from "macros/link.njk" import link %}

{% extends "layouts/default.njk" %}

{% block back_link %}

    <div role="navigation" "aria-label"="back link to previous page">
        {{ govukBackLink({text: lang.back_to_your_companies, href: backLinkHref }) }}
    </div>

{% endblock %}

{% block main_content %}

    {% set company_association = companyAssociations.items | first %}

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <h1 class="govuk-heading-l">
                <span class="govuk-caption-l">{{company_association.companyName}}</span>
                {{lang.people_digitally_authorised_to_file_online}}
            </h1>
            {{ govukInsetText({
                    text: lang.anyone_with_access_to_the_current_authentication
                })
            }}
            {{ govukButton({text: lang.add_new_authorised_person, href: buttonHref}) }}
        </div>
    </div>

    {% set rows = [] %}
    {% for association in companyAssociations.items %}
        {% set row = [] %}
        {% set row = (row.push({text: association.userEmail}), row) %}
        {% set row = (row.push({
            text: association.displayName if association.displayName else 
                ""
        }), row) %}
        {% if association
            .status
            .toLowerCase() === "confirmed" %}
            {% set tag = govukTag({text: association.status.toUpperCase(), classes: "govuk-tag--green"}) %}
            {% set row = (row.push({html: tag}), row) %}
            {% set removeLink = link(lang.remove, removeUrl, {
                userEmail: association.userEmail,
                companyNumber: association.companyNumber
            }) %}
            {% set row = (row.push({html: removeLink}), row) %}
            {% set row = (row.push({text: ""}), row) %}
        {% else %}
            {% set text = association
                .status
                .toUpperCase() | replace(" ", "<br>") %}
            {% set tag = govukTag({html: text, classes: "govuk-tag--yellow"}) %}
            {% set row = (row.push({html: tag}), row) %}
            {% set cancelLink = link(lang.cancel, cancelUrl, {userEmail: association.userEmail})%}
            {% set row = (row.push({html: cancelLink}), row) %}
            {% set resendEmailLink = link(lang.resend_email, resendEmailUrl, {userEmail: association.userEmail})%}
            {% set row = (row.push({html: resendEmailLink}), row) %}
        {% endif %}
        {% set rows = (rows.push(row), rows) %}
    {% endfor %}

    <div class="govuk-grid-row govuk-!-padding-top-3">
        <div class="govuk-grid-column-full">
            {{ govukTable({
                    caption: lang.details_of_authorised_people,
                    captionClasses: "govuk-table__caption--m",
                    firstCellIsHeader: true,
                    head: [
                        {
                            text: lang.email_address
                        },
                        {
                            text: lang.name
                        },
                        {
                            text: lang.status
                        },
                        {
                            text: ""
                        },
                        {
                            text: ""
                        }
                    ],
                    rows: rows
                })
            }}
        </div>
    </div>

{% endblock %}